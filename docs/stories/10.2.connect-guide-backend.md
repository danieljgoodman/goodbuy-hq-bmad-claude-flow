# Story 10.2: Connect Guide Generation to Backend

## Status
Done

## Story
**As a** premium subscriber,  
**I want** the guide generation buttons to successfully create detailed implementation guides using the existing backend services,  
**so that** I receive comprehensive step-by-step action plans for my business improvements.

## Acceptance Criteria

1. "Generate Implementation Guide" button calls existing GuideService.generateImplementationGuide() API successfully
2. Guide generation request includes proper evaluation context and opportunity data
3. Generated guides are saved to database using existing ImplementationGuide table structure
4. Success/error states are properly displayed to user during guide generation process
5. Generated guides become immediately accessible via existing guide viewing components
6. API calls follow existing error handling and loading state patterns
7. No modifications needed to existing GuideService backend logic

## Tasks / Subtasks

- [ ] Implement guide generation API call in OpportunitiesList component (AC: 1, 2)
  - [ ] Add guide generation handler function to OpportunitiesList component
  - [ ] Map opportunity data to GuideGenerationRequest format
  - [ ] Include evaluation ID, user ID, and business context in API request
- [ ] Add loading and error states for guide generation (AC: 4, 6)
  - [ ] Add loading state management for individual opportunities
  - [ ] Implement error handling with user-friendly error messages
  - [ ] Add success confirmation when guide generation completes
- [ ] Integrate with existing API endpoint (AC: 1, 7)
  - [ ] Use existing /api/guides/generate POST endpoint
  - [ ] Ensure request payload matches existing GuideGenerationRequest schema
  - [ ] Verify response handling matches existing API patterns
- [ ] Connect generated guides to guide viewing system (AC: 5)
  - [ ] Add navigation to generated guides after successful creation
  - [ ] Ensure guides appear in existing guide listing components
  - [ ] Verify guide viewing components work with newly generated guides

## Dev Notes

### Relevant Source Tree
- **API Endpoint**: `/src/app/api/guides/generate/route.ts` - Existing guide generation API
- **Service**: `/src/lib/services/GuideService.ts` - Backend service logic for guide generation  
- **Component**: `/src/components/evaluation/opportunities-list.tsx` - Needs guide generation functionality
- **Types**: `/src/lib/services/GuideService.ts` - Contains GuideGenerationRequest interface

### Integration Points
- **Existing API**: /api/guides/generate expects GuideGenerationRequest with userId, evaluationId, improvementCategory, businessContext, improvementOpportunity
- **Database**: Uses existing ImplementationGuide and GuideStep tables - no schema changes needed
- **Guide Viewing**: Generated guides should integrate with existing guide viewing components

### Critical Constraints
- **Use Existing APIs**: Must use existing GuideService.generateImplementationGuide() without modifications
- **Data Mapping**: Opportunity data must be properly mapped to GuideGenerationRequest format
- **Error Handling**: Follow existing error handling patterns used throughout the application

### Business Context Mapping
- Extract businessName, industry, size from evaluation data
- Map opportunity title, description, and impact estimates
- Include user subscription tier and preferences

### Testing
#### Test File Location
- Unit tests: `/src/__tests__/components/evaluation/opportunities-list.test.tsx`
- Integration tests: `/src/__tests__/api/guides/generate.test.ts`

#### Test Standards
- Mock API responses for successful guide generation
- Test error handling for failed guide generation
- Verify proper data mapping from opportunities to API requests

#### Testing Requirements
- Mock GuideService API calls
- Test loading states during guide generation
- Verify navigation to generated guides works correctly
- Test with different opportunity types and data structures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-12 | 1.0 | Initial story creation | BMad Master |

## Dev Agent Record

### Tasks Completed âœ…
- [x] Implement guide generation API call in OpportunitiesList component (AC: 1, 2)
  - [x] Add guide generation handler function to OpportunitiesList component
  - [x] Map opportunity data to GuideGenerationRequest format
  - [x] Include evaluation ID, user ID, and business context in API request
- [x] Add loading and error states for guide generation (AC: 4, 6)
  - [x] Add loading state management for individual opportunities
  - [x] Implement error handling with user-friendly error messages
  - [x] Add success confirmation when guide generation completes
- [x] Integrate with existing API endpoint (AC: 1, 7)
  - [x] Use existing /api/guides/generate POST endpoint
  - [x] Ensure request payload matches existing GuideGenerationRequest schema
  - [x] Verify response handling matches existing API patterns
- [x] Connect generated guides to guide viewing system (AC: 5)
  - [x] Add navigation to generated guides after successful creation
  - [x] Ensure guides appear in existing guide listing components
  - [x] Verify guide viewing components work with newly generated guides

### Implementation Details
- **Files Modified**: 
  - `/src/components/evaluation/opportunities-list.tsx` - Added full guide generation functionality
  - `/src/app/evaluation/[id]/page.tsx` - Added business context props
- **API Integration**: Successfully integrated with existing `/api/guides/generate` endpoint
- **Data Mapping**: Properly maps opportunity data to GuideGenerationRequest schema
- **User Experience**: Added loading states, error handling, and success confirmation
- **Navigation**: Automatic redirect to /progress page after successful guide generation

### File List
- `apps/web/src/components/evaluation/opportunities-list.tsx` (modified)
- `apps/web/src/app/evaluation/[id]/page.tsx` (modified)

### Agent Model Used
Claude Sonnet 4 (Development Agent)

## QA Results
*This section will be populated during QA review*