# Story 4.2: Comprehensive User Account & Settings Management

## Status
Approved

## Story
**As a** registered user,
**I want** comprehensive account management and platform customization capabilities,
**so that** I can control my subscription, data privacy, and platform preferences while maintaining security and compliance.

## Acceptance Criteria
1. Account settings page with profile information management, business data updates, and subscription tier visibility
2. Subscription management including plan changes, billing history, payment method updates, and cancellation workflow with retention offers
3. Data privacy controls with options to export personal data, delete account information, and manage data sharing preferences
4. Notification preferences for emails, platform updates, improvement reminders, and market intelligence alerts with granular control
5. Security settings including password changes, two-factor authentication setup, and login history with suspicious activity alerts

## Tasks / Subtasks
- [ ] Create comprehensive account settings data models (AC: 1,3,4,5)
  - [ ] Design UserProfile model for extended profile management
  - [ ] Create UserPreferences model for notification and privacy settings
  - [ ] Design SecuritySettings model for authentication and activity tracking
  - [ ] Add DataExportRequest model for privacy compliance
  - [ ] Update database schema with new settings tables
- [ ] Build account profile management (AC: 1)
  - [ ] Create AccountProfileCard component for basic profile editing
  - [ ] Build BusinessInfoCard component for business data management
  - [ ] Implement SubscriptionStatusCard showing current plan and features
  - [ ] Add profile photo upload with image processing and validation
  - [ ] Create form validation and error handling for profile updates
- [ ] Implement subscription management interface (AC: 2)
  - [ ] Build SubscriptionManager component with plan comparison
  - [ ] Create PlanChangeModal for upgrade/downgrade flows
  - [ ] Implement BillingHistoryTable with downloadable invoices
  - [ ] Build PaymentMethodManager for card management
  - [ ] Create CancellationFlow with retention offers and feedback collection
- [ ] Develop data privacy and compliance controls (AC: 3)
  - [ ] Create DataPrivacyPanel with GDPR-compliant controls
  - [ ] Build DataExportTool for personal data download
  - [ ] Implement AccountDeletionFlow with confirmation and retention
  - [ ] Add DataSharingPreferences for third-party consent management
  - [ ] Create privacy policy acknowledgment tracking
- [ ] Build notification preferences system (AC: 4)
  - [ ] Create NotificationPreferencesPanel with granular controls
  - [ ] Build EmailPreferencesCard for email subscription management
  - [ ] Implement PlatformAlertsCard for in-app notification settings
  - [ ] Add MarketIntelligenceAlertsCard for AI insight notifications
  - [ ] Create notification frequency and timing controls
- [ ] Implement security settings and monitoring (AC: 5)
  - [ ] Build PasswordChangeForm with strength validation
  - [ ] Create TwoFactorAuthSetup component with QR code generation
  - [ ] Implement LoginHistoryTable with session management
  - [ ] Build SecurityAlertsPanel for suspicious activity notifications
  - [ ] Add device management for trusted devices
- [ ] Create API endpoints for account management (AC: 1,2,3,4,5)
  - [ ] Build /api/account/profile endpoints for profile CRUD
  - [ ] Create /api/account/preferences endpoints for settings management
  - [ ] Implement /api/account/security endpoints for security settings
  - [ ] Build /api/account/data-export endpoint for privacy compliance
  - [ ] Create /api/account/delete endpoint with proper data cleanup

## Dev Notes

### Previous Story Dependencies
**Epic 1 Requirements**:
- User authentication system from Story 1.1 provides foundation for account management
- Database User model serves as base for extended profile management

**Epic 3 Requirements**:
- Stripe subscription system from Story 3.1 for subscription management integration
- Payment and billing infrastructure for subscription controls
- Premium access system for feature-based settings

### Data Models
**Extended UserProfile Model**:
```typescript
interface UserProfile {
  id: string;
  userId: string;
  firstName: string;
  lastName: string;
  email: string;
  phone?: string;
  avatar?: string;
  businessName?: string;
  businessIndustry?: string;
  businessSize?: string;
  timezone: string;
  language: string;
  createdAt: Date;
  updatedAt: Date;
}
```

**UserPreferences Model**:
```typescript
interface UserPreferences {
  id: string;
  userId: string;
  notifications: {
    email_updates: boolean;
    platform_alerts: boolean;
    market_intelligence: boolean;
    improvement_reminders: boolean;
    billing_updates: boolean;
  };
  privacy: {
    data_sharing_analytics: boolean;
    data_sharing_marketing: boolean;
    public_profile: boolean;
  };
  dashboard: {
    default_view: string;
    chart_preferences: Record<string, any>;
  };
  updatedAt: Date;
}
```

**SecuritySettings Model**:
```typescript
interface SecuritySettings {
  id: string;
  userId: string;
  twoFactorEnabled: boolean;
  twoFactorSecret?: string;
  backupCodes?: string[];
  loginNotifications: boolean;
  trustedDevices: {
    id: string;
    device_name: string;
    last_used: Date;
    trusted_until: Date;
  }[];
  sessionTimeout: number; // minutes
  lastPasswordChange: Date;
  updatedAt: Date;
}
```

### API Specifications
**Account Management Endpoints**:
- `GET /api/account/profile` - Get user profile information
- `PUT /api/account/profile` - Update user profile
- `GET /api/account/preferences` - Get user preferences
- `PUT /api/account/preferences` - Update user preferences  
- `GET /api/account/security` - Get security settings
- `PUT /api/account/security/password` - Change password
- `POST /api/account/security/2fa/setup` - Setup 2FA
- `POST /api/account/security/2fa/verify` - Verify 2FA
- `GET /api/account/security/sessions` - Get login history
- `DELETE /api/account/security/sessions/{id}` - Revoke session
- `POST /api/account/data-export` - Request data export
- `DELETE /api/account/delete` - Delete account with confirmation

### Component Specifications
**Account Management Components**:
```
src/components/account/
├── AccountSettingsLayout.tsx          # Main settings page layout
├── profile/
│   ├── AccountProfileCard.tsx         # Basic profile management
│   ├── BusinessInfoCard.tsx           # Business information
│   └── SubscriptionStatusCard.tsx     # Current plan display
├── subscription/
│   ├── SubscriptionManager.tsx        # Plan management
│   ├── PlanChangeModal.tsx           # Upgrade/downgrade flow
│   ├── BillingHistoryTable.tsx       # Billing history
│   └── PaymentMethodManager.tsx      # Payment method management
├── privacy/
│   ├── DataPrivacyPanel.tsx          # Privacy controls
│   ├── DataExportTool.tsx            # Data export interface
│   └── AccountDeletionFlow.tsx       # Account deletion
├── notifications/
│   ├── NotificationPreferencesPanel.tsx  # Notification settings
│   ├── EmailPreferencesCard.tsx         # Email preferences
│   └── AlertSettingsCard.tsx            # Alert preferences
└── security/
    ├── PasswordChangeForm.tsx            # Password management
    ├── TwoFactorAuthSetup.tsx           # 2FA setup
    ├── LoginHistoryTable.tsx           # Login history
    └── SecurityAlertsPanel.tsx         # Security alerts
```

### File Locations
**Account Management Implementation**:
```
apps/web/src/
├── app/account/
│   ├── page.tsx                       # Main account settings page
│   ├── profile/page.tsx               # Profile management page
│   ├── subscription/page.tsx          # Subscription management page
│   ├── privacy/page.tsx               # Privacy settings page
│   ├── notifications/page.tsx         # Notification preferences page
│   └── security/page.tsx              # Security settings page
├── lib/services/
│   ├── AccountService.ts              # Account management operations
│   ├── UserPreferencesService.ts      # Preferences management
│   └── SecurityService.ts             # Security operations
└── lib/repositories/
    ├── UserProfileRepository.ts       # Profile data access
    ├── UserPreferencesRepository.ts   # Preferences data access
    └── SecuritySettingsRepository.ts  # Security settings data
```

### Tech Stack Requirements
**Account Management Stack**:
- **2FA Integration**: Use libraries like `speakeasy` for TOTP generation
- **Image Processing**: Sharp or similar for avatar image processing
- **Data Export**: CSV/JSON export functionality for compliance
- **Session Management**: JWT session handling with proper expiration
- **Security**: Rate limiting for sensitive operations like password changes

### Technical Constraints
**Security Requirements**:
- Hash passwords using bcrypt with proper salt rounds
- Implement rate limiting on sensitive endpoints (password change, 2FA)
- Log all security-related actions for audit trails
- Use secure session management with proper expiration
- Implement CSRF protection for state-changing operations

**Privacy Compliance Requirements**:
- GDPR-compliant data export in machine-readable format
- Proper data deletion with cascade handling
- Privacy policy version tracking and consent management
- Data sharing consent with granular controls
- Activity logging for privacy-related actions

### Testing Requirements
**Account Management Testing Strategy**:
- Test profile management CRUD operations
- Test subscription management integration with Stripe
- Test 2FA setup and verification flows
- Test data export functionality and format
- Test account deletion with proper cleanup
- Test notification preference changes and delivery
- Test security features like password changes and session management

## Testing
**Testing Standards for this Story**:
- Test location: `apps/web/src/__tests__/account/`
- Use Vitest for service layer testing
- Use React Testing Library for component testing
- Test form validation and error handling
- Verify integration with existing authentication system
- Test privacy compliance features (data export, deletion)
- Test security features with proper authentication

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-09-09 | 1.0 | Initial story creation for Epic 4 | BMad Master |

## Dev Agent Record

### Agent Model Used
*To be added during development*

### Debug Log References
*To be added during development*

### Completion Notes List
*To be added during development*

### File List
*To be added during development*

## QA Results
*To be added after implementation*